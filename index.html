<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æ—…éŠè¨˜å¸³ App</title>
    
   <!-- å¼·åˆ¶æŒ‡å®šå®Œæ•´ç¶²å€ï¼ŒiPhone æ‰ä¸æœƒè¿·è·¯ -->
    <link rel="icon" href="https://chikomi002.github.io/my-trip-app/icon.JPG">
    <link rel="apple-touch-icon" href="https://chikomi002.github.io/my-trip-app/icon.JPG">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;900&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* [v-cloak] æ˜¯ä¸€å€‹ä¿è­·ç½©ï¼Œåœ¨ Vue å•Ÿå‹•å‰éš±è—äº‚ç¢¼ */
        [v-cloak] { display: none !important; }

        :root {
            --color-cream: #f8f5f1;
            --color-latte: #d2b48c;
            --color-mocha: #6f4e37;
            --color-text: #2c2c2c;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--color-text);
            background-color: #fcece0;
        }

        #app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: var(--color-cream);
        }

        .horizontal-scroll-container::-webkit-scrollbar { display: none; }
        .horizontal-scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        .itinerary-card {
            border-left: 5px solid var(--color-latte);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .font-extrabold { font-weight: 900; }
        
        .tab-button-active {
            background-color: var(--color-latte);
            color: white !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button-inactive {
            background-color: #f1f1f1;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .milk-tea-bg { background-color: var(--color-cream); }
        .milk-tea-text { color: var(--color-mocha); }
        .milk-tea-accent { background-color: var(--color-latte); color: var(--color-mocha); }
        .milk-tea-accent.text-white { color: white; }
    </style>
</head>
<body class="milk-tea-bg p-4 sm:p-6">

<div id="app" v-cloak>
    <main class="milk-tea-bg rounded-xl shadow-lg p-4 sm:p-6 min-h-[80vh]">
        
        <div v-if="configError" class="flex flex-col items-center justify-center h-full py-20 text-center">
            <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ç¨‹å¼é‚„æ²’é€£æ¥åˆ°è³‡æ–™åº«</h2>
            <p class="text-gray-600 mb-4 px-4">
                è«‹æ‰“é–‹ index.html æª”æ¡ˆï¼Œæ»‘åˆ°æœ€ä¸‹é¢ï¼Œ<br>
                å°‡ <b>Firebase Config</b> å¡«å…¥æ­£ç¢ºçš„ä½ç½®ã€‚
            </p>
            <p class="text-xs text-gray-400 bg-gray-100 p-2 rounded">éŒ¯èª¤è¨Šæ¯: {{ configError }}</p>
        </div>

        <div v-else-if="!currentUser" class="flex flex-col items-center justify-center h-full py-10">
            <h1 class="text-3xl font-extrabold mb-8 text-center milk-tea-text">
                ğŸ‘‹ æ­¡è¿å›ä¾†ï¼<br>è«‹å•æ‚¨æ˜¯å“ªä½å®¶äººï¼Ÿ
            </h1>
            <div class="grid grid-cols-2 gap-4 w-full">
                <button v-for="member in familyMembers" :key="member" 
                        @click="loginAs(member)"
                        class="p-6 rounded-2xl bg-white shadow-md border-2 border-transparent hover:border-milk-tea-accent hover:shadow-lg transition-all flex flex-col items-center">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-3 text-2xl">
                        {{ getAvatar(member) }}
                    </div>
                    <span class="font-bold text-lg text-gray-700">{{ member }}</span>
                </button>
            </div>
        </div>

        <div v-else>
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-extrabold milk-tea-text">
                    ğŸŒ {{ appTitle }}
                </h1>
                <div class="flex items-center space-x-2">
                    <span class="px-3 py-1 bg-milk-tea-accent text-white rounded-full text-sm font-bold shadow-sm">
                        {{ currentUser }}
                    </span>
                    <button @click="logout" class="text-xs text-gray-400 underline">åˆ‡æ›</button>
                </div>
            </div>
            
            <div v-if="isInitializing" class="text-center py-20 bg-white rounded-xl shadow-inner">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-milk-tea-accent mx-auto mb-4"></div>
                <p class="text-gray-600 font-bold">è³‡æ–™åŒæ­¥ä¸­...</p>
            </div>

            <div v-else-if="!isSetupComplete">
                <div v-if="isAdmin">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-milk-tea-accent">
                        <h2 class="text-2xl font-extrabold text-center milk-tea-text mb-2">âœ¨ é–‹å§‹è¦åŠƒæ–°æ—…ç¨‹</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">App æ‡‰ç”¨ç¨‹å¼åç¨±</label>
                                <input type="text" v-model="wizard.appNameInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ä¾‹: å¤§é˜ªå®¶æ—æ—…éŠ" />
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">ç›®çš„åœ°</label>
                                <input type="text" v-model="wizard.destinationInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ä¾‹: å¤§é˜ª" />
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">åŒ¯ç‡è¨­å®š (1 å¤–å¹£ = ? å°å¹£)</label>
                                <div class="relative">
                                    <input type="number" v-model.number="wizard.rateInput" step="0.001" class="w-full p-3 border border-gray-300 rounded-lg text-right pr-20" />
                                    <span class="absolute right-0 top-0 h-full flex items-center pr-3 font-mono text-sm text-gray-500">TWD</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">èµ·å§‹æ—¥æœŸ</label>
                                <input type="date" v-model="wizard.startDateInput" class="w-full p-3 border border-gray-300 rounded-lg" />
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">çµæŸæ—¥æœŸ</label>
                                <input type="date" v-model="wizard.endDateInput" class="w-full p-3 border border-gray-300 rounded-lg" />
                            </div>
                        </div>
                        <button type="button" @click="saveInitialSetup" :disabled="!isWizardValid" 
                                :class="['w-full mt-6 py-3 font-bold rounded-lg transition-all', isWizardValid ? 'milk-tea-accent text-white hover:opacity-90' : 'bg-gray-300 text-gray-500 cursor-not-allowed']">
                            å»ºç«‹è¡Œç¨‹
                        </button>
                    </div>
                </div>
                <div v-else class="text-center py-20">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">â³</div>
                    <h2 class="text-xl font-bold text-gray-700 mb-2">è¡Œç¨‹å°šæœªå»ºç«‹</h2>
                    <p class="text-gray-500">è«‹ç­‰å¾… <span class="font-bold text-milk-tea-accent">è±¬å§</span> å®Œæˆè¨­å®šã€‚</p>
                </div>
            </div>

            <div v-else>
                <h2 class="text-xl font-extrabold mb-4 text-center">
                    {{ tripSettings.destination }} 
                    <span class="text-base font-normal block text-gray-600">({{ tripDays[0]?.display }} - {{ tripDays.slice(-1)[0]?.display }})</span>
                </h2>

                <div class="flex justify-center mb-6 space-x-2">
                    <button type="button" @click="activeTab = 'itinerary'" :class="['flex-1 py-2 rounded-xl font-bold transition-colors shadow-md border', activeTab === 'itinerary' ? 'tab-button-active border-milk-tea-accent' : 'tab-button-inactive border-gray-300']">å…±ç”¨è¡Œç¨‹</button>
                    <button type="button" @click="activeTab = 'wallet'" :class="['flex-1 py-2 rounded-xl font-bold transition-colors shadow-md border', activeTab === 'wallet' ? 'tab-button-active border-milk-tea-accent' : 'tab-button-inactive border-gray-300']">æˆ‘çš„éŒ¢åŒ…</button>
                </div>

                <section class="mb-6">
                    <div class="flex space-x-3 pb-3 horizontal-scroll-container overflow-x-scroll">
                        <template v-for="(date, index) in tripDays" :key="date.iso">
                            <button type="button" @click="selectedDate = date.iso" :class="['py-2 px-4 rounded-full font-bold flex-shrink-0 whitespace-nowrap shadow-md', selectedDate === date.iso ? 'milk-tea-accent text-white shadow-md shadow-gray-400' : 'bg-white text-gray-600 hover:bg-gray-50']">
                                {{ date.display }}
                            </button>
                        </template>
                    </div>
                </section>
                
                <div v-if="activeTab === 'itinerary'">
                    <section class="mb-8">
                        <div v-if="itinerary[selectedDate]?.length === 0" class="text-center py-10 bg-white rounded-xl text-gray-500 border border-dashed border-gray-300">
                            <i data-lucide="map-pin" class="w-8 h-8 mx-auto mb-2 text-gray-400"></i>
                            <p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                        </div>
                        <div class="space-y-4">
                            <div v-for="(item, index) in itinerary[selectedDate]" :key="item.id || index" class="itinerary-card p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                                <div v-if="!item.isEditing" class="flex justify-between items-start">
                                    <div class="flex-grow">
                                        <p class="text-lg font-extrabold milk-tea-text">{{ item.time }} - {{ item.location }}</p>
                                        <p class="text-sm text-gray-500 mt-1">{{ item.notes || 'ç„¡å‚™è¨»' }}</p>
                                    </div>
                                    <div class="flex flex-col space-y-2 flex-shrink-0 ml-4">
                                        <a :href="getSingleMapLink(item.location)" target="_blank" class="p-2 rounded-full milk-tea-accent text-white btn-minimal shadow-sm flex items-center justify-center"><i data-lucide="navigation" class="w-4 h-4"></i></a>
                                        <button type="button" @click="editItem(selectedDate, index)" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 btn-minimal shadow-sm"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                        <button type="button" @click="deleteItem(selectedDate, index)" class="p-2 rounded-full bg-red-100 hover:bg-red-200 text-red-600 btn-minimal shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <div v-else class="space-y-3">
                                    <input v-model="item.time" type="time" class="w-full p-2 border border-gray-300 rounded-lg font-bold text-lg" />
                                    <input v-model="item.location" type="text" class="w-full p-2 border border-gray-300 rounded-lg" />
                                    <textarea v-model="item.notes" class="w-full p-2 border border-gray-300 rounded-lg resize-none"></textarea>
                                    <button type="button" @click="saveItem(selectedDate, index)" class="w-full py-2 milk-tea-accent text-white font-bold rounded-lg btn-minimal">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" @click="addNewItem(selectedDate)" class="w-full mt-4 py-3 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-lg shadow-md btn-minimal flex items-center justify-center">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> æ–°å¢è¡Œç¨‹
                        </button>
                    </section>
                    
                    <section class="p-6 bg-white rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold mb-4 flex items-center milk-tea-text"><i data-lucide="map" class="w-5 h-5 mr-2"></i> åœ°åœ–</h3>
                        <div v-if="mapUrl" class="rounded-lg overflow-hidden border border-gray-200">
                            <iframe :src="mapUrl" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                        </div>
                    </section>
                </div>
                
                <div v-if="activeTab === 'wallet'">
                    <div v-if="isWalletUninitialized" class="mb-8 bg-white p-6 rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                        <h3 class="text-xl font-extrabold mb-4 text-center milk-tea-text">ğŸ‘› è¨­å®šæ‚¨çš„é ç®—</h3>
                        <div class="space-y-4">
                            <div class="flex space-x-2">
                                <input type="number" v-model.number="budgetSetup.amountTWD" class="w-full p-3 border border-gray-300 rounded-lg text-right font-bold text-lg" placeholder="è¼¸å…¥å°å¹£" />
                                <span class="p-3 font-bold flex items-center bg-gray-100 rounded-lg">TWD</span>
                            </div>
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <span class="text-sm font-bold text-gray-500">ç´„ {{ tripSettings.currency }}</span>
                                <span class="text-xl font-extrabold text-green-600">{{ budgetSetupCalculated.toLocaleString('en-US', { minimumFractionDigits: 2 }) }}</span>
                            </div>
                            <button @click="initializeWallet" :disabled="budgetSetup.amountTWD <= 0" 
                                    :class="['w-full py-3 font-bold rounded-lg transition-all', budgetSetup.amountTWD > 0 ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed']">
                                å•Ÿç”¨éŒ¢åŒ…
                            </button>
                        </div>
                    </div>

                    <div v-else>
                         <section class="p-4 bg-white rounded-xl shadow-lg mb-6 border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-milk-tea-accent text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">å€‹äººéŒ¢åŒ…</div>
                            <h3 class="text-lg font-extrabold flex items-center milk-tea-text mb-2">æˆ‘çš„é¤˜é¡</h3>
                            <div class="flex flex-col space-y-1">
                                <div class="flex justify-between items-center text-base">
                                    <span class="font-extrabold">{{ tripSettings.currency }}:</span> 
                                    <span class="font-mono text-xl text-green-600 font-extrabold">{{ wallet.currentForeign.toLocaleString('en-US', { minimumFractionDigits: 2 }) }}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm border-t border-gray-100 pt-1">
                                    <span class="text-gray-600">å°å¹£ (TWD):</span> 
                                    <span class="font-mono text-base ml-1 text-gray-700">{{ wallet.currentTWD.toLocaleString('zh-TW', { minimumFractionDigits: 0 }) }}</span>
                                </div>
                            </div>
                        </section>

                        <section class="mb-8">
                            <h3 class="text-xl font-bold mb-4">{{ selectedDateDisplay }} äº¤æ˜“ç´€éŒ„</h3>
                            
                            <div class="p-4 bg-white rounded-xl shadow-lg mb-6 border border-gray-100">
                                <h4 class="font-extrabold text-lg mb-3 milk-tea-text">æ–°å¢äº¤æ˜“</h4>
                                <div class="space-y-3">
                                    <div class="flex space-x-2">
                                        <select v-model="newTransaction.type" class="w-1/3 p-2 border rounded-lg text-sm">
                                            <option value="expense">æ”¯å‡º</option>
                                            <option value="topup">å…¥å¸³</option>
                                        </select>
                                        <input type="time" v-model="newTransaction.time" class="w-1/3 p-2 border rounded-lg text-sm" />
                                        <select v-model="newTransaction.currency" class="w-1/3 p-2 border rounded-lg text-sm">
                                            <option :value="tripSettings.currency">{{ tripSettings.currency }}</option>
                                            <option value="TWD">TWD</option>
                                        </select>
                                    </div>
                                    <input type="number" v-model.number="newTransaction.amount" placeholder="é‡‘é¡" class="w-full p-2 border rounded-lg text-right font-mono" />
                                    <input type="text" v-model="newTransaction.notes" placeholder="è£œå……èªªæ˜ / é …ç›®åç¨±" class="w-full p-2 border rounded-lg text-sm" />
                                    <button type="button" @click="addTransaction" :disabled="!isTransactionValid" :class="['w-full py-2 font-bold rounded-lg transition-colors', isTransactionValid ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed']">
                                        ç´€éŒ„ {{ newTransaction.type === 'expense' ? 'æ”¯å‡º' : 'å…¥å¸³' }}
                                    </button>
                                </div>
                            </div>

                            <div v-if="filteredTransactions.length > 0" class="space-y-3">
                                <div v-for="tx in filteredTransactions" :key="tx.id" :class="['p-3 rounded-xl shadow-sm border', tx.type === 'expense' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200']">
                                    <div v-if="editingTxId === tx.id" class="space-y-3">
                                        <div class="flex space-x-2">
                                            <input type="number" v-model.number="editingTransaction.amount" class="w-full p-2 border rounded-lg text-right" />
                                        </div>
                                        <input type="text" v-model="editingTransaction.notes" class="w-full p-2 border rounded-lg" />
                                        <div class="flex space-x-2 pt-2">
                                            <button type="button" @click="saveEdit" class="flex-[2] py-2 bg-green-600 text-white rounded-lg">å„²å­˜</button>
                                            <button type="button" @click="cancelEdit" class="flex-1 py-2 bg-gray-400 text-white rounded-lg">å–æ¶ˆ</button>
                                            <button type="button" @click="deleteTransaction(tx.id)" class="flex-none w-12 py-2 bg-red-100 text-red-600 rounded-lg flex items-center justify-center"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                        </div>
                                    </div>
                                    <div v-else class="flex justify-between items-center">
                                        <div class="flex-grow">
                                            <p class="font-bold text-sm">{{ tx.time }} - {{ tx.notes }}</p>
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4">
                                            <div :class="['font-extrabold text-lg', tx.type === 'expense' ? 'text-red-700' : 'text-green-700']">
                                                {{ tx.type === 'expense' ? '-' : '+' }}{{ tx.amount.toLocaleString() }} {{ tx.currency }}
                                            </div>
                                            <button @click="editTransaction(tx)" class="p-1 bg-gray-200 rounded-full"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <section class="p-6 bg-white rounded-xl shadow-lg mb-8">
                            <h3 class="text-xl font-bold mb-4 flex items-center milk-tea-text"><i data-lucide="dollar-sign" class="w-5 h-5 mr-2"></i> é›™å‘åŒ¯ç‡æ›ç®—</h3>
                            <div class="mb-6 text-center border-b pb-4 border-gray-100">
                                <label class="text-sm font-medium text-gray-700">å³æ™‚åŒ¯ç‡ (1 {{ tripSettings.currency }} = ? TWD)</label>
                                <input type="number" v-model.number="tripSettings.rateTWD" @input="updateExchangeRate" step="0.0001" class="w-40 mx-auto block p-2 border-2 border-gray-300 rounded-lg text-lg font-extrabold text-center mt-2" />
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" v-model.number="foreignInput" class="w-full p-3 border-2 border-gray-200 rounded-lg text-xl font-extrabold text-right" />
                                <div class="w-full p-3 bg-gray-50 rounded-lg text-xl font-extrabold text-right border-2 border-gray-200 text-gray-800">{{ twdOutput.toLocaleString('zh-TW', { minimumFractionDigits: 2 }) }}</div>
                            </div>
                        </section>
                    </div>
                </div>

                <section v-if="isAdmin" class="mb-8 p-4 bg-red-50 rounded-xl border border-red-200">
                    <p class="text-sm font-bold text-red-700 mb-3 flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> ç®¡ç†è€…å°ˆå€</p>
                    <button type="button" @click="resetSetup" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors shadow-lg">é‡è¨­è¡Œç¨‹</button>
                </section>
            </div>
        </div>
    </main>
</div>

<script type="module">
    // æ­¥é©Ÿï¼š
    // 1. å» Firebase Console > Project Settings
    // 2. ä¸‹æ»‘æ‰¾åˆ° "Your apps" > "SDK setup and configuration"
    // 3. é¸æ“‡ "Config"
    // 4. æŠŠé‚£ä¸€æ®µå…§å®¹è¤‡è£½éä¾†ï¼Œæ›¿æ›æ‰ä¸‹æ–¹çš„ firebaseConfig å…§å®¹

    const firebaseConfig = {
        apiKey: "AIzaSyCrNe8ZxZCofC5mxlmkXJ-Jjr5bA19_B4I",
        authDomain: "trip-app-2026.firebaseapp.com",
        projectId: "trip-app-2026",
        storageBucket: "trip-app-2026.firebasestorage.app",
        messagingSenderId: "92743336008",
        appId: "1:92743336008:web:7e5da82d9b10cd8f67587d"
    };

    // =================================================================
    // â–²â–²â–²â–²â–² è¨­å®šå€å¡ŠçµæŸï¼Œä¸‹æ–¹ç¨‹å¼ç¢¼ä¸éœ€è¦æ”¹å‹• â–²â–²â–²â–²â–²
    // =================================================================

    const appId = 'family-trip-v2';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const { ref, computed, watch, onMounted, nextTick } = Vue;
    const generateId = () => Math.random().toString(36).substring(2, 9);
    const FAMILY_MEMBERS = ['è±¬å§', 'è±¬çˆ¸çˆ¸', 'è±¬åª½åª½', 'è±¬å¼Ÿ'];
    const ADMIN_USER = 'è±¬å§';

    const DESTINATION_SETTINGS = {
        'default': { currency: 'CUR', language: 'Chinese', name: 'é€šç”¨åœ°é»' },
        'tokyo': { currency: 'JPY', language: 'Japanese', name: 'æ±äº¬' },
        'osaka': { currency: 'JPY', language: 'Japanese', name: 'å¤§é˜ª' },
        'kyoto': { currency: 'JPY', language: 'Japanese', name: 'äº¬éƒ½' }
    };

    const getSettings = (destInput) => {
        if (!destInput) return DESTINATION_SETTINGS['default'];
        const key = destInput.toLowerCase();
        for (const dKey in DESTINATION_SETTINGS) {
            if (key.includes(dKey) || DESTINATION_SETTINGS[dKey].name.includes(key)) return DESTINATION_SETTINGS[dKey];
        }
        return DESTINATION_SETTINGS['default'];
    };

    const App = {
        setup() {
            const isInitializing = ref(true);
            const configError = ref(null);
            const currentUser = ref(null);
            let db, tripDocRef;
            
            // Data State
            const tripSettings = ref({ appName: 'æˆ‘çš„æ—…éŠè¨ˆç•«', destination: 'å¤§é˜ª', startDate: '', endDate: '', currency: 'JPY', rateTWD: 0.22 });
            const itinerary = ref({});
            const wallet = ref({ initialTWD: 0, initialForeign: 0, currentTWD: 0, currentForeign: 0 });
            const transactions = ref([]);
            
            // Wizard State
            const isSetupComplete = ref(false);
            const wizard = ref({ appNameInput: '', destinationInput: '', rateInput: 0.22, startDateInput: '', endDateInput: '' });
            const budgetSetup = ref({ amountTWD: 0 });
            
            // UI State
            const activeTab = ref('itinerary');
            const selectedDate = ref('');
            const editingTxId = ref(null);
            const editingTransaction = ref(null);
            
            // Forms
            const newTransaction = ref({ time: '12:00', type: 'expense', currency: 'JPY', amount: 0, notes: '' });
            const foreignInput = ref(0);
            const twdInput = ref(0);

            // Computed
            const isAdmin = computed(() => currentUser.value === ADMIN_USER);
            const appTitle = computed(() => tripSettings.value.appName || 'My Trip');
            const isWizardValid = computed(() => wizard.value.appNameInput && wizard.value.startDateInput && wizard.value.endDateInput);
            const budgetSetupCalculated = computed(() => {
                const rate = parseFloat(tripSettings.value.rateTWD) || 0;
                return rate > 0 ? budgetSetup.value.amountTWD / rate : 0;
            });
            const isWalletUninitialized = computed(() => wallet.value.initialTWD === 0 && wallet.value.initialForeign === 0 && transactions.value.length === 0);
            const isTransactionValid = computed(() => newTransaction.value.amount > 0 && newTransaction.value.notes);
            
            const tripDays = computed(() => {
                if(!tripSettings.value.startDate || !tripSettings.value.endDate) return [];
                const dates = [];
                let curr = new Date(tripSettings.value.startDate);
                const end = new Date(tripSettings.value.endDate);
                while(curr <= end) {
                    dates.push({ iso: curr.toISOString().split('T')[0], display: `${curr.getMonth()+1}/${curr.getDate()}` });
                    curr.setDate(curr.getDate() + 1);
                }
                return dates;
            });

            const filteredTransactions = computed(() => transactions.value.filter(tx => tx.date === selectedDate.value));
            const selectedDateDisplay = computed(() => tripDays.value.find(d => d.iso === selectedDate.value)?.display || '');
            const twdOutput = computed(() => foreignInput.value * (tripSettings.value.rateTWD || 0));

            // Map Logic
            const mapUrl = computed(() => {
                const loc = itinerary.value[selectedDate.value]?.find(i => i.location)?.location || tripSettings.value.destination;
                return `https://maps.google.com/maps?q=${encodeURIComponent(loc)}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
            });

            // Methods
            const loginAs = (member) => {
                currentUser.value = member;
                localStorage.setItem('myTripUser', member);
                loadUserData();
            };
            const logout = () => {
                currentUser.value = null;
                localStorage.removeItem('myTripUser');
            };
            const getAvatar = (name) => name.includes('çˆ¸') ? 'ğŸ‘¨ğŸ»' : name.includes('åª½') ? 'ğŸ‘©ğŸ»' : name.includes('å¼Ÿ') ? 'ğŸ‘¦ğŸ»' : 'ğŸ‘§ğŸ»';
            
            let globalData = null;
            const loadUserData = () => {
                if(!globalData || !currentUser.value) return;
                const userData = globalData.userWallets?.[currentUser.value] || { wallet: { initialTWD: 0, initialForeign: 0, currentTWD: 0, currentForeign: 0 }, transactions: [] };
                wallet.value = userData.wallet;
                transactions.value = userData.transactions || [];
                recalculateWallet();
            };

            const recalculateWallet = () => {
                let twd = wallet.value.initialTWD || 0;
                let foreign = wallet.value.initialForeign || 0;
                transactions.value.forEach(tx => {
                    if (tx.currency === 'TWD') {
                        twd += (tx.type === 'topup' ? tx.amount : -tx.amount);
                    } else {
                        foreign += (tx.type === 'topup' ? tx.amount : -tx.amount);
                    }
                });
                wallet.value.currentTWD = Math.round(twd);
                wallet.value.currentForeign = parseFloat(foreign.toFixed(2));
            };

            const updateFirestore = async (data, merge = true) => {
                if(tripDocRef) await setDoc(tripDocRef, data, { merge });
            };

            const saveUserWallet = async () => {
                if(currentUser.value) {
                    await updateFirestore({ userWallets: { [currentUser.value]: { wallet: wallet.value, transactions: transactions.value } } });
                }
            };

            const initializeWallet = async () => {
                wallet.value = {
                    initialTWD: budgetSetup.value.amountTWD,
                    initialForeign: budgetSetupCalculated.value,
                    currentTWD: budgetSetup.value.amountTWD,
                    currentForeign: budgetSetupCalculated.value
                };
                await saveUserWallet();
            };

            const addTransaction = async () => {
                const tx = { ...newTransaction.value, id: generateId(), date: selectedDate.value, userId: currentUser.value };
                transactions.value.push(tx);
                recalculateWallet();
                await saveUserWallet();
                newTransaction.value.amount = 0;
                newTransaction.value.notes = '';
            };
            
            const editTransaction = (tx) => { editingTransaction.value = JSON.parse(JSON.stringify(tx)); editingTxId.value = tx.id; };
            const cancelEdit = () => { editingTxId.value = null; };
            const saveEdit = async () => {
                const idx = transactions.value.findIndex(t => t.id === editingTxId.value);
                if(idx !== -1) transactions.value[idx] = editingTransaction.value;
                recalculateWallet();
                cancelEdit();
                await saveUserWallet();
            };
            const deleteTransaction = async (id) => {
                transactions.value = transactions.value.filter(t => t.id !== id);
                recalculateWallet();
                await saveUserWallet();
            };

            const saveInitialSetup = async () => {
                const settings = getSettings(wizard.value.destinationInput);
                const newSettings = { 
                    appName: wizard.value.appNameInput, 
                    destination: settings.name, 
                    startDate: wizard.value.startDateInput, 
                    endDate: wizard.value.endDateInput, 
                    currency: settings.currency, 
                    rateTWD: parseFloat(wizard.value.rateInput),
                    language: settings.language
                };
                const initItinerary = {};
                tripDays.value.forEach(d => initItinerary[d.iso] = []);
                
                await updateFirestore({ tripSettings: newSettings, itinerary: initItinerary, userWallets: {} }, false); // Overwrite
            };

            const resetSetup = async () => {
                await updateFirestore({ tripSettings: {}, itinerary: {}, userWallets: {} }, false);
                isSetupComplete.value = false;
            };

            // Itinerary Methods
            const mockWeather = () => Math.floor(Math.random() * 8) + 10;
            const addNewItem = async (date) => {
                if(!itinerary.value[date]) itinerary.value[date] = [];
                itinerary.value[date].push({ id: generateId(), time: '10:00', location: '', notes: '', temp: mockWeather(), isEditing: true });
                await updateFirestore({ itinerary: itinerary.value });
            };
            const saveItem = async (date, idx) => {
                itinerary.value[date][idx].isEditing = false;
                await updateFirestore({ itinerary: itinerary.value });
            };
            const deleteItem = async (date, idx) => {
                itinerary.value[date].splice(idx, 1);
                await updateFirestore({ itinerary: itinerary.value });
            };
            const editItem = (date, idx) => { itinerary.value[date][idx].isEditing = true; };
            const getSingleMapLink = (loc) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(tripSettings.value.destination + ' ' + loc)}`;

            const updateExchangeRate = debounce(async () => {
                await updateFirestore({ tripSettings: tripSettings.value });
            }, 500);

            // Init
            const init = async () => {
                // Config Check
                if (firebaseConfig.apiKey.includes("è«‹åœ¨æ­¤å¡«å…¥")) {
                    configError.value = "è«‹å¡«å¯«æ­£ç¢ºçš„ Firebase Configï¼";
                    isInitializing.value = false;
                    return;
                }

                setLogLevel('error');
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                
                tripDocRef = doc(db, `artifacts/${appId}/data`, 'main');
                onSnapshot(tripDocRef, (snap) => {
                    const data = snap.data();
                    globalData = data;
                    if(data?.tripSettings?.startDate) {
                        tripSettings.value = data.tripSettings;
                        itinerary.value = data.itinerary || {};
                        isSetupComplete.value = true;
                        if(currentUser.value) loadUserData();
                    } else {
                        isSetupComplete.value = false;
                    }
                    isInitializing.value = false;
                    nextTick(() => lucide.createIcons());
                });
            };

            watch(selectedDate, () => nextTick(() => lucide.createIcons()));
            onMounted(() => {
                const saved = localStorage.getItem('myTripUser');
                if(saved && FAMILY_MEMBERS.includes(saved)) currentUser.value = saved;
                init();
            });

            return {
                isInitializing, configError, currentUser, isAdmin, FAMILY_MEMBERS, loginAs, logout, getAvatar,
                appTitle, activeTab, wallet, newTransaction, isTransactionValid, addTransaction, filteredTransactions, 
                isSetupComplete, wizard, isWizardValid, saveInitialSetup, resetSetup, 
                tripSettings, itinerary, tripDays, selectedDate, selectedDateDisplay, addNewItem, editItem, saveItem, deleteItem, 
                budgetSetup, budgetSetupCalculated, initializeWallet, isWalletUninitialized,
                editingTxId, editingTransaction, editTransaction, cancelEdit, saveEdit, deleteTransaction,
                mapUrl, getSingleMapLink, twdOutput, foreignInput, twdInput, updateExchangeRate
            };
        }
    };
    Vue.createApp(App).mount('#app');
</script>
</body>
</html>
