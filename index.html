<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ appTitle }}</title>
     <!-- å¼·åˆ¶æŒ‡å®šå®Œæ•´ç¶²å€ï¼ŒiPhone æ‰ä¸æœƒè¿·è·¯ -->
    <link rel="icon" href="https://chikomi002.github.io/my-trip-app/icon.JPG">
    <link rel="apple-touch-icon" href="https://chikomi002.github.io/my-trip-app/icon.JPG">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;900&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* å®šç¾©å¥¶èŒ¶è‰²ç³»è®Šæ•¸ */
        :root {
            --color-cream: #f8f5f1; /* è»Ÿå¥¶æ²¹ç™½ (èƒŒæ™¯) */
            --color-latte: #d2b48c; /* æ·ºæ‹¿éµè‰² (Accent/æŒ‰éˆ•) */
            --color-mocha: #6f4e37; /* æ·±æ‘©å¡è‰² (æ–‡å­—/æ·± Accent) */
            --color-text: #2c2c2c; /* ç²—é»‘å­—é«” */
        }

        /* è‡ªå®šç¾© Tailwind é…ç½® */
        body {
            font-family: 'Inter', sans-serif;
            color: var(--color-text);
            /* æ¨¡æ“¬çç å¥¶èŒ¶èƒŒæ™¯ */
            background-color: #fcece0; /* ç•¥å¸¶ç²‰èª¿çš„å¥¶èŒ¶åº•è‰² */
        }

        /* App å®¹å™¨æ¨¡æ“¬æ‰‹æ©Ÿç•Œé¢ */
        #app {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: var(--color-cream); /* å…§å±¤ä½¿ç”¨è»Ÿå¥¶æ²¹ç™½ */
        }

        /* æ©«å‘æ»¾å‹•æ¢æ¨£å¼ (éš±è—æ»¾å‹•æ¢ä½†ä¿æŒæ»¾å‹•åŠŸèƒ½) */
        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .horizontal-scroll-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* è¡Œç¨‹å¡ç‰‡çš„æ¥µç°¡æ¨£å¼ */
        .itinerary-card {
            border-left: 5px solid var(--color-latte);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .font-extrabold {
             font-weight: 900; /* ç¢ºä¿ Inter 900 æ‡‰ç”¨ */
        }
        
        /* Tab æŒ‰éˆ•å„ªåŒ– */
        .tab-button-active {
            background-color: var(--color-latte);
            color: white !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button-inactive {
            background-color: #f1f1f1;
            color: #666;
            border: 1px solid #e0e0e0;
        }
        
        /* Wizard & Modal æ¨£å¼ */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .wizard-content {
            background-color: var(--color-cream);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Milk Tea Custom Colors */
        .milk-tea-bg {
            background-color: var(--color-cream);
        }
        .milk-tea-text {
            color: var(--color-mocha);
        }
        .milk-tea-accent {
            background-color: var(--color-latte);
            color: var(--color-mocha);
        }
        .milk-tea-accent:hover {
             background-color: #bfa07d;
        }
        .milk-tea-accent.text-white {
            color: white;
        }
    </style>
</head>
<body class="milk-tea-bg p-4 sm:p-6">

<div id="app">
    <main class="milk-tea-bg rounded-xl shadow-lg p-4 sm:p-6 min-h-[80vh]">
        
        <div v-if="!currentUser" class="flex flex-col items-center justify-center h-full py-10">
            <h1 class="text-3xl font-extrabold mb-8 text-center milk-tea-text">
                ğŸ‘‹ æ­¡è¿å›ä¾†ï¼<br>è«‹å•æ‚¨æ˜¯å“ªä½å®¶äººï¼Ÿ
            </h1>
            <div class="grid grid-cols-2 gap-4 w-full">
                <button v-for="member in familyMembers" :key="member" 
                        @click="loginAs(member)"
                        class="p-6 rounded-2xl bg-white shadow-md border-2 border-transparent hover:border-milk-tea-accent hover:shadow-lg transition-all flex flex-col items-center">
                    <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mb-3 text-2xl">
                        {{ getAvatar(member) }}
                    </div>
                    <span class="font-bold text-lg text-gray-700">{{ member }}</span>
                </button>
            </div>
        </div>

        <div v-else>
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-extrabold milk-tea-text">
                    ğŸŒ {{ appTitle }}
                </h1>
                <div class="flex items-center space-x-2">
                    <span class="px-3 py-1 bg-milk-tea-accent text-white rounded-full text-sm font-bold shadow-sm">
                        {{ currentUser }}
                    </span>
                    <button @click="logout" class="text-xs text-gray-400 underline">åˆ‡æ›</button>
                </div>
            </div>
            
            <div v-if="isInitializing" class="text-center py-20 bg-white rounded-xl shadow-inner">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-milk-tea-accent mx-auto mb-4"></div>
                <p class="text-gray-600 font-bold">è³‡æ–™åŒæ­¥ä¸­...</p>
            </div>

            <div v-else-if="!isSetupComplete">
                
                <div v-if="isAdmin">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-milk-tea-accent">
                        <h2 class="text-2xl font-extrabold text-center milk-tea-text mb-2">
                            âœ¨ é–‹å§‹è¦åŠƒæ–°æ—…ç¨‹
                        </h2>
                        <p class="text-sm text-gray-500 text-center mb-6">è¨­å®šå®Œæˆå¾Œï¼Œå…¶ä»–å®¶äººå³å¯ç™»å…¥æŸ¥çœ‹ã€‚</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">App æ‡‰ç”¨ç¨‹å¼åç¨±</label>
                                <input type="text" v-model="wizard.appNameInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ä¾‹: å¤§é˜ªå®¶æ—æ—…éŠ" />
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">ç›®çš„åœ°</label>
                                <input type="text" v-model="wizard.destinationInput" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ä¾‹: å¤§é˜ª, æ±äº¬" />
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">åŒ¯ç‡è¨­å®š (1 å¤–å¹£ = ? å°å¹£)</label>
                                <div class="relative">
                                    <input type="number" v-model.number="wizard.rateInput" step="0.001" class="w-full p-3 border border-gray-300 rounded-lg text-right pr-20" />
                                    <span class="absolute right-0 top-0 h-full flex items-center pr-3 font-mono text-sm text-gray-500">TWD</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">èµ·å§‹æ—¥æœŸ</label>
                                <input type="date" v-model="wizard.startDateInput" class="w-full p-3 border border-gray-300 rounded-lg" />
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">çµæŸæ—¥æœŸ</label>
                                <input type="date" v-model="wizard.endDateInput" class="w-full p-3 border border-gray-300 rounded-lg" />
                            </div>
                        </div>

                        <button type="button" @click="saveInitialSetup" :disabled="!isWizardValid" 
                                :class="['w-full mt-6 py-3 font-bold rounded-lg transition-all', isWizardValid ? 'milk-tea-accent text-white hover:opacity-90' : 'bg-gray-300 text-gray-500 cursor-not-allowed']">
                            å»ºç«‹è¡Œç¨‹
                        </button>
                    </div>
                </div>

                <div v-else class="text-center py-20">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">â³</div>
                    <h2 class="text-xl font-bold text-gray-700 mb-2">è¡Œç¨‹å°šæœªå»ºç«‹</h2>
                    <p class="text-gray-500">è«‹ç­‰å¾… <span class="font-bold text-milk-tea-accent">è±¬å§</span> å®Œæˆåˆå§‹è¨­å®šå¾Œ<br>é‡æ–°æ•´ç†é é¢å³å¯ã€‚</p>
                </div>
            </div>

            <div v-else>
                
                <h2 class="text-xl font-extrabold mb-4 text-center">
                    {{ tripSettings.destination }} 
                    <span class="text-base font-normal block text-gray-600">({{ tripDays[0]?.display }} - {{ tripDays.slice(-1)[0]?.display }})</span>
                </h2>

                <div class="flex justify-center mb-6 space-x-2">
                    <button type="button" @click="activeTab = 'itinerary'" :class="['flex-1 py-2 rounded-xl font-bold transition-colors shadow-md border', activeTab === 'itinerary' ? 'tab-button-active border-milk-tea-accent' : 'tab-button-inactive border-gray-300']">å…±ç”¨è¡Œç¨‹</button>
                    <button type="button" @click="activeTab = 'wallet'" :class="['flex-1 py-2 rounded-xl font-bold transition-colors shadow-md border', activeTab === 'wallet' ? 'tab-button-active border-milk-tea-accent' : 'tab-button-inactive border-gray-300']">æˆ‘çš„éŒ¢åŒ…</button>
                </div>

                <section class="mb-6">
                    <h3 class="text-xl font-bold mb-3">é¸æ“‡æ—¥æœŸ</h3>
                    <div class="flex space-x-3 pb-3 horizontal-scroll-container overflow-x-scroll">
                        <template v-for="(date, index) in tripDays" :key="date.iso">
                            <button type="button" @click="selectedDate = date.iso" :class="['py-2 px-4 rounded-full font-bold flex-shrink-0 whitespace-nowrap shadow-md', selectedDate === date.iso ? 'milk-tea-accent text-white shadow-md shadow-gray-400' : 'bg-white text-gray-600 hover:bg-gray-50']">
                                {{ date.display }}
                            </button>
                        </template>
                    </div>
                </section>
                
                <div v-if="activeTab === 'itinerary'">
                    <section class="mb-8">
                        <div v-if="itinerary[selectedDate]?.length === 0" class="text-center py-10 bg-white rounded-xl text-gray-500 border border-dashed border-gray-300">
                            <i data-lucide="map-pin" class="w-8 h-8 mx-auto mb-2 text-gray-400"></i>
                            <p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                        </div>
                        <div class="space-y-4">
                            <div v-for="(item, index) in itinerary[selectedDate]" :key="item.id || index" class="itinerary-card p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                                <div v-if="!item.isEditing" class="flex justify-between items-start">
                                    <div class="flex-grow">
                                        <p class="text-lg font-extrabold milk-tea-text">{{ item.time }} - {{ item.location }}</p>
                                        <p class="text-sm text-gray-500 mt-1">{{ item.notes || 'ç„¡å‚™è¨»' }}</p>
                                        <div class="mt-2 flex items-center text-sm text-blue-600 font-medium bg-blue-50/50 rounded-full px-3 py-1 w-fit">
                                            <i data-lucide="cloud-sun" class="w-4 h-4 mr-1"></i> æ°£æº«: <span class="ml-1 font-bold">{{ item.temp }}Â°C</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col space-y-2 flex-shrink-0 ml-4">
                                        <div @click="toggleMapPin(item)" :class="['p-2 rounded-full cursor-pointer shadow-sm flex items-center justify-center', item.checked ? 'bg-red-100' : 'bg-gray-100 hover:bg-gray-200']">
                                            <i data-lucide="map-pin" :class="['w-4 h-4', item.checked ? 'text-red-500 fill-red-500' : 'text-gray-600']"></i>
                                        </div>
                                        <a :href="getSingleMapLink(item.location)" target="_blank" class="p-2 rounded-full milk-tea-accent text-white btn-minimal shadow-sm flex items-center justify-center"><i data-lucide="navigation" class="w-4 h-4"></i></a>
                                        <button type="button" @click="editItem(selectedDate, index)" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 btn-minimal shadow-sm"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                        <button type="button" @click="deleteItem(selectedDate, index)" class="p-2 rounded-full bg-red-100 hover:bg-red-200 text-red-600 btn-minimal shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <div v-else class="space-y-3">
                                    <input v-model="item.time" type="time" class="w-full p-2 border border-gray-300 rounded-lg font-bold text-lg" />
                                    <input v-model="item.location" type="text" placeholder="åœ°é»åç¨±" class="w-full p-2 border border-gray-300 rounded-lg" />
                                    <textarea v-model="item.notes" placeholder="å‚™è¨»" class="w-full p-2 border border-gray-300 rounded-lg resize-none"></textarea>
                                    <button type="button" @click="saveItem(selectedDate, index)" class="w-full py-2 milk-tea-accent text-white font-bold rounded-lg btn-minimal">å„²å­˜å…±ç”¨è¡Œç¨‹</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" @click="addNewItem(selectedDate)" class="w-full mt-4 py-3 bg-gray-800 hover:bg-gray-900 text-white font-bold rounded-lg shadow-md btn-minimal flex items-center justify-center">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i> æ–°å¢è¡Œç¨‹
                        </button>
                    </section>
                    
                    <section class="p-6 bg-white rounded-xl shadow-lg mb-8">
                        <h3 class="text-xl font-bold mb-4 flex items-center milk-tea-text"><i data-lucide="map" class="w-5 h-5 mr-2"></i> æ¯æ—¥è¡Œç¨‹åœ°åœ–</h3>
                        <div v-if="mapUrl" class="rounded-lg overflow-hidden border border-gray-200">
                            <iframe :src="mapUrl" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                        </div>
                        <div v-else class="text-center py-10 bg-gray-50 rounded-xl text-gray-500">åœ°åœ–è¼‰å…¥ä¸­...</div>
                    </section>
                </div>
                
                <div v-if="activeTab === 'wallet'">
                    
                    <div v-if="isWalletUninitialized" class="mb-8 bg-white p-6 rounded-xl shadow-lg border-2 border-dashed border-gray-300">
                        <h3 class="text-xl font-extrabold mb-4 text-center milk-tea-text">ğŸ‘› è¨­å®šæ‚¨çš„æ—…éŠé ç®—</h3>
                        <p class="text-sm text-gray-500 text-center mb-4">è¼¸å…¥æ‚¨é€™æ¬¡æ‰“ç®—å¸¶å¤šå°‘éŒ¢ (å°å¹£)ï¼Œç³»çµ±å°‡è‡ªå‹•æ›ç®—ã€‚</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">æº–å‚™æ”œå¸¶çš„é‡‘é¡</label>
                                <div class="flex space-x-2">
                                    <input type="number" v-model.number="budgetSetup.amountTWD" class="w-full p-3 border border-gray-300 rounded-lg text-right font-bold text-lg" placeholder="è¼¸å…¥å°å¹£é‡‘é¡" />
                                    <span class="p-3 font-bold flex items-center bg-gray-100 rounded-lg">TWD</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-center text-gray-400">
                                <i data-lucide="arrow-down" class="w-5 h-5"></i>
                            </div>

                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <span class="text-sm font-bold text-gray-500">ç´„ç­‰æ–¼ {{ tripSettings.currency }}</span>
                                <span class="text-xl font-extrabold text-green-600">{{ budgetSetupCalculated.toLocaleString('en-US', { minimumFractionDigits: 2 }) }}</span>
                            </div>

                            <button @click="initializeWallet" :disabled="budgetSetup.amountTWD <= 0" 
                                    :class="['w-full py-3 font-bold rounded-lg transition-all', budgetSetup.amountTWD > 0 ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed']">
                                ç¢ºèªé ç®—ä¸¦å•Ÿç”¨éŒ¢åŒ…
                            </button>
                        </div>
                    </div>

                    <div v-else>
                         <section class="p-4 bg-white rounded-xl shadow-lg mb-6 border border-gray-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-milk-tea-accent text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">å€‹äººéŒ¢åŒ…</div>
                            <h3 class="text-lg font-extrabold flex items-center milk-tea-text mb-2">
                                <i data-lucide="wallet" class="w-5 h-5 mr-2"></i>
                                æˆ‘çš„éŒ¢åŒ…é¤˜é¡
                            </h3>
                            <div class="flex flex-col space-y-1">
                                <div class="flex justify-between items-center text-base">
                                    <span class="font-extrabold">{{ tripSettings.currency }}:</span> 
                                    <span class="font-mono text-xl text-green-600 font-extrabold">{{ wallet.currentForeign.toLocaleString('en-US', { minimumFractionDigits: 2 }) }}</span>
                                </div>
                                <div class="flex justify-between items-center text-sm border-t border-gray-100 pt-1">
                                    <span class="text-gray-600">å°å¹£ (TWD):</span> 
                                    <span class="font-mono text-base ml-1 text-gray-700">{{ wallet.currentTWD.toLocaleString('zh-TW', { minimumFractionDigits: 0 }) }}</span>
                                </div>
                            </div>
                        </section>

                        <section class="mb-8">
                            <h3 class="text-xl font-bold mb-4">{{ selectedDateDisplay }} å€‹äººäº¤æ˜“ç´€éŒ„</h3>
                            
                            <div class="p-4 bg-white rounded-xl shadow-lg mb-6 border border-gray-100">
                                <h4 class="font-extrabold text-lg mb-3 milk-tea-text">æ–°å¢å€‹äººäº¤æ˜“</h4>
                                <div class="space-y-3">
                                    <div class="flex space-x-2">
                                        <select v-model="newTransaction.type" class="w-1/3 p-2 border rounded-lg text-sm">
                                            <option value="expense">æ”¯å‡º</option>
                                            <option value="topup">å…¥å¸³</option>
                                        </select>
                                        <input type="time" v-model="newTransaction.time" class="w-1/3 p-2 border rounded-lg text-sm" />
                                        <select v-model="newTransaction.currency" class="w-1/3 p-2 border rounded-lg text-sm">
                                            <option :value="tripSettings.currency">{{ tripSettings.currency }}</option>
                                            <option value="TWD">TWD</option>
                                        </select>
                                    </div>
                                    <input type="number" v-model.number="newTransaction.amount" placeholder="é‡‘é¡" class="w-full p-2 border rounded-lg text-right font-mono" />
                                    <input type="text" v-model="newTransaction.notes" placeholder="è£œå……èªªæ˜ / é …ç›®åç¨±" class="w-full p-2 border rounded-lg text-sm" />
                                    <button type="button" @click="addTransaction" :disabled="!isTransactionValid" :class="['w-full py-2 font-bold rounded-lg transition-colors', isTransactionValid ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed']">
                                        ç´€éŒ„ {{ newTransaction.type === 'expense' ? 'æ”¯å‡º' : 'å…¥å¸³' }}
                                    </button>
                                </div>
                            </div>

                            <div v-if="filteredTransactions.length > 0" class="space-y-3">
                                <div v-for="tx in filteredTransactions" :key="tx.id" :class="['p-3 rounded-xl shadow-sm border', tx.type === 'expense' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200']">
                                    
                                    <div v-if="editingTxId === tx.id" class="space-y-3">
                                        <div class="flex space-x-2">
                                            <select v-model="editingTransaction.type" class="w-1/3 p-2 border rounded-lg text-sm">
                                                <option value="expense">æ”¯å‡º</option>
                                                <option value="topup">å…¥å¸³</option>
                                            </select>
                                            <input type="time" v-model="editingTransaction.time" class="w-1/3 p-2 border rounded-lg text-sm" />
                                            <select v-model="editingTransaction.currency" class="w-1/3 p-2 border rounded-lg text-sm">
                                                <option :value="tripSettings.currency">{{ tripSettings.currency }}</option>
                                                <option value="TWD">TWD</option>
                                            </select>
                                        </div>
                                        <input type="number" v-model.number="editingTransaction.amount" placeholder="é‡‘é¡" class="w-full p-2 border rounded-lg text-right font-mono" />
                                        <input type="text" v-model="editingTransaction.notes" placeholder="è£œå……èªªæ˜" class="w-full p-2 border rounded-lg text-sm" />

                                        <div class="flex space-x-2 pt-2">
                                            <button type="button" @click="saveEdit" class="flex-[2] py-2 font-bold rounded-lg transition-colors bg-green-600 text-white hover:bg-green-700">å„²å­˜</button>
                                            <button type="button" @click="cancelEdit" class="flex-1 py-2 font-bold rounded-lg transition-colors bg-gray-400 text-white hover:bg-gray-500">å–æ¶ˆ</button>
                                            <button type="button" @click="deleteTransaction(tx.id)" class="flex-none w-12 py-2 font-bold rounded-lg transition-colors bg-red-100 text-red-600 border border-red-200 hover:bg-red-200 flex items-center justify-center">
                                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div v-else class="flex justify-between items-center">
                                        <div class="flex-grow">
                                            <p class="font-bold text-sm">{{ tx.time }} - {{ tx.notes }}</p>
                                            <p class="text-xs text-gray-500">{{ tx.type === 'expense' ? 'æ”¯å‡º' : 'å…¥å¸³' }}</p>
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4 flex-shrink-0">
                                            <div :class="['font-extrabold text-lg', tx.type === 'expense' ? 'text-red-700' : 'text-green-700']">
                                                {{ tx.type === 'expense' ? '-' : '+' }}{{ tx.amount.toLocaleString('en-US', { minimumFractionDigits: tx.currency === tripSettings.currency ? 2 : 0 }) }} {{ tx.currency }}
                                            </div>
                                            <button type="button" @click="editTransaction(tx)" class="p-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600">
                                                <i data-lucide="pencil" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center py-10 bg-white rounded-xl text-gray-500 border border-dashed border-gray-300">
                                <i data-lucide="wallet" class="w-8 h-8 mx-auto mb-2 text-gray-400"></i>
                                <p>æœ¬æ—¥ç„¡äº¤æ˜“ç´€éŒ„</p>
                            </div>
                        </section>
                        
                        <section class="p-6 bg-white rounded-xl shadow-lg mb-8">
                            <h3 class="text-xl font-bold mb-4 flex items-center milk-tea-text"><i data-lucide="dollar-sign" class="w-5 h-5 mr-2"></i> é›™å‘åŒ¯ç‡æ›ç®—</h3>
                            <div class="mb-6 text-center border-b pb-4 border-gray-100">
                                <label class="text-sm font-medium text-gray-700">å³æ™‚åŒ¯ç‡è¨­å®š (1 {{ tripSettings.currency }} = ? TWD)</label>
                                <div class="relative mt-1 mx-auto w-40">
                                    <input type="number" v-model.number="tripSettings.rateTWD" @input="updateExchangeRate" step="0.0001" class="w-full p-2 border-2 border-gray-300 rounded-lg text-lg font-extrabold text-center" />
                                </div>
                            </div>
                            <div class="mb-6 border-b pb-4 border-gray-100">
                                <label class="block text-md font-extrabold text-gray-700 mb-2">{{ tripSettings.currency }} â†’ å°å¹£ (TWD)</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="number" v-model.number="foreignInput" class="w-full p-3 border-2 border-gray-200 focus:border-milk-tea-accent rounded-lg text-xl font-extrabold text-right" />
                                    <div class="w-full p-3 bg-gray-50 rounded-lg text-xl font-extrabold text-right border-2 border-gray-200 text-gray-800">{{ twdOutput.toLocaleString('zh-TW', { minimumFractionDigits: 2 }) }}</div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-md font-extrabold text-gray-700 mb-2">å°å¹£ (TWD) â†’ {{ tripSettings.currency }}</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="number" v-model.number="twdInput" class="w-full p-3 border-2 border-gray-200 focus:border-milk-tea-accent rounded-lg text-xl font-extrabold text-right" />
                                    <div class="w-full p-3 bg-gray-50 rounded-lg text-xl font-extrabold text-right border-2 border-gray-200 text-gray-800">{{ foreignOutput.toLocaleString('en-US', { minimumFractionDigits: 2 }) }}</div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>

                <section v-if="isAdmin" class="mb-8 p-4 bg-red-50 rounded-xl border border-red-200">
                    <p class="text-sm font-bold text-red-700 mb-3 flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> ç®¡ç†è€…å°ˆå€</p>
                    <button type="button" @click="resetSetup" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors shadow-lg">é‡è¨­è¡Œç¨‹ (å°‡æ¸…é™¤æ‰€æœ‰äººçš„è³‡æ–™)</button>
                </section>
            </div>
        </div>
    </main>
</div>




<script type="module">
    // â–¼â–¼â–¼â–¼â–¼ è«‹å¾é€™è£¡é–‹å§‹æ›¿æ› â–¼â–¼â–¼â–¼â–¼
    
    // 1. çµ¦æ‚¨çš„ App å–å€‹è‹±æ–‡ä»£è™Ÿ (éš¨æ„ï¼Œä¾‹å¦‚ 'my-family-trip')
    const appId = 'my-family-trip'; 

    // 2. è²¼ä¸Šæ‚¨å¾ Firebase å¾Œå°è¤‡è£½ä¾†çš„è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyCrNe8ZxZCofC5mxlmkXJ-Jjr5bA19_B4I",
  authDomain: "trip-app-2026.firebaseapp.com",
  projectId: "trip-app-2026",
  storageBucket: "trip-app-2026.firebasestorage.app",
  messagingSenderId: "92743336008",
  appId: "1:92743336008:web:7e5da82d9b10cd8f67587d",
  measurementId: "G-DDSMLPDLJP"
    };

    // â–²â–²â–²â–²â–² æ›¿æ›çµæŸ â–²â–²â–²â–²â–²

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // ... (å¾Œé¢ä¸ç”¨å‹•)


    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    const { ref, computed, watch, onMounted, nextTick } = Vue;
    
    const debounce = (func, delay) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    };
    const generateId = () => Math.random().toString(36).substring(2, 9);
    
    // ============ 1. å®¶äººè¨­å®š ============
    const FAMILY_MEMBERS = ['è±¬å§', 'è±¬çˆ¸çˆ¸', 'è±¬åª½åª½', 'è±¬å¼Ÿ'];
    const ADMIN_USER = 'è±¬å§'; // åªæœ‰é€™å€‹äººèƒ½é‡è¨­å’Œåˆå§‹è¨­å®š
    
    const DESTINATION_SETTINGS = {
        'tokyo': { currency: 'JPY', language: 'Japanese', name: 'æ±äº¬', exampleLocation: 'æ·ºè‰å¯º' },
        'osaka': { currency: 'JPY', language: 'Japanese', name: 'å¤§é˜ª', exampleLocation: 'é“é “å €' },
        'kyoto': { currency: 'JPY', language: 'Japanese', name: 'äº¬éƒ½', exampleLocation: 'æ¸…æ°´å¯º' },
        'london': { currency: 'GBP', language: 'English', name: 'å€«æ•¦', exampleLocation: 'å¤§ç¬¨é˜' },
        'newyork': { currency: 'USD', language: 'English', name: 'ç´ç´„', exampleLocation: 'è‡ªç”±å¥³ç¥åƒ' },
        'default': { currency: 'CUR', language: 'Chinese', name: 'é€šç”¨åœ°é»', exampleLocation: 'ä¸»æœƒå ´' }
    };

    const getSettings = (destInput) => {
        if (!destInput) return DESTINATION_SETTINGS['default'];
        const key = destInput.toLowerCase().trim();
        for (const dKey in DESTINATION_SETTINGS) {
            if (key.includes(dKey) || DESTINATION_SETTINGS[dKey].name.includes(key)) {
                return DESTINATION_SETTINGS[dKey];
            }
        }
        return DESTINATION_SETTINGS['default'];
    };

    const App = {
        setup() {
            const isInitializing = ref(true); 
            // currentUser ç”¨ä¾†å„²å­˜ç¾åœ¨æ˜¯èª° (å®¶äººåå­—)
            const currentUser = ref(null); 
            
            let db;
            let tripDocRef = null;
            const activeTab = ref('itinerary'); 
            const isSetupComplete = ref(false); 
            
            // åˆå§‹è¨­å®š (ä¸åŒ…å«éŒ¢åŒ…äº†)
            const wizard = ref({ appNameInput: '', destinationInput: '', rateInput: 0.22, startDateInput: '', endDateInput: '' });
            
            // éŒ¢åŒ…ç¨ç«‹é ç®—è¨­å®š
            const budgetSetup = ref({ amountTWD: 0 });

            const editingTxId = ref(null);
            const editingTransaction = ref(null); 

            // ============ Computed Properties ============
            const isAdmin = computed(() => currentUser.value === ADMIN_USER);
            
            const detectedSettings = computed(() => getSettings(wizard.value.destinationInput));
            
            const isWizardValid = computed(() => {
                const rate = parseFloat(wizard.value.rateInput);
                return (wizard.value.appNameInput.trim() && wizard.value.destinationInput.trim() && rate > 0 && !isNaN(rate) && wizard.value.startDateInput && wizard.value.endDateInput && new Date(wizard.value.startDateInput) <= new Date(wizard.value.endDateInput));
            });
            
            const budgetSetupCalculated = computed(() => {
                const rate = parseFloat(tripSettings.value.rateTWD) || 0;
                if (rate > 0) return budgetSetup.value.amountTWD / rate;
                return 0;
            });

            // åˆ¤æ–·éŒ¢åŒ…æ˜¯å¦æœªåˆå§‹åŒ– (åˆå§‹é‡‘é¡ç‚º0 ä¸” æ²’äº¤æ˜“)
            const isWalletUninitialized = computed(() => {
                return wallet.value.initialTWD === 0 && wallet.value.initialForeign === 0 && transactions.value.length === 0;
            });

            // State
            const tripSettings = ref({ appName: 'æˆ‘çš„æ—…éŠè¨ˆç•«', destination: 'é—œè¥¿æ—…éŠ', startDate: '2026-01-11', endDate: '2026-01-14', currency: 'JPY', rateTWD: 0.20, language: 'Japanese', exampleLocation: 'æ¸…æ°´å¯º' });
            const itinerary = ref({}); 
            const wallet = ref({ initialTWD: 0, initialForeign: 0, currentTWD: 0, currentForeign: 0 }); // å€‹äººéŒ¢åŒ…
            const transactions = ref([]); // å€‹äººäº¤æ˜“ç´€éŒ„

            const appTitle = computed(() => tripSettings.value.appName || 'My Trip App');
            watch(appTitle, (newTitle) => { document.title = newTitle; }, { immediate: true });
            
            // Date Logic
            const tripDays = computed(() => {
                const dates = [];
                if(!tripSettings.value.startDate || !tripSettings.value.endDate) return [];
                let currentDate = new Date(tripSettings.value.startDate + 'T00:00:00Z');
                const endDate = new Date(tripSettings.value.endDate + 'T00:00:00Z');
                while (currentDate.getTime() <= endDate.getTime()) {
                    const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const dd = String(currentDate.getDate()).padStart(2, '0');
                    const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][currentDate.getDay()];
                    dates.push({ iso: currentDate.toISOString().split('T')[0], display: `${mm}/${dd} (${dayOfWeek})` });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return dates;
            });
            const selectedDate = ref('');
            watch(tripDays, (newDays) => {
                if (newDays.length > 0 && !newDays.some(d => d.iso === selectedDate.value)) {
                    selectedDate.value = newDays[0].iso;
                }
            }, { immediate: true });

            const selectedDateDisplay = computed(() => {
                const day = tripDays.value.find(d => d.iso === selectedDate.value);
                return day ? day.display : 'é¸æ“‡æ—¥æœŸ';
            });
            
            // Exchange Logic
            const foreignInput = ref(0); 
            const twdOutput = computed(() => (foreignInput.value * (parseFloat(tripSettings.value.rateTWD) || 0)));
            const twdInput = ref(0); 
            const foreignOutput = computed(() => {
                 const rate = parseFloat(tripSettings.value.rateTWD);
                 return (rate > 0) ? twdInput.value / rate : 0;
            });

            // Map Logic
            const currentLocation = ref('å‡ºç™¼åœ°');
            const mapLocations = computed(() => {
                const currentDayItinerary = itinerary.value[selectedDate.value] || [];
                const checkedLocations = currentDayItinerary.filter(item => item.checked && item.location?.trim()).map(item => item.location);
                if (checkedLocations.length > 0) return checkedLocations;
                const validItems = currentDayItinerary.filter(item => item.location?.trim());
                return validItems.length > 0 ? [validItems[validItems.length - 1].location] : [];
            });

            const mapUrl = computed(() => {
                const locations = mapLocations.value;
                if (locations.length === 0 || !tripSettings.value.destination) {
                     const encodedDestination = encodeURIComponent(tripSettings.value.destination || 'æ—…éŠç›®çš„åœ°');
                     return `https://maps.google.com/maps?q=${encodedDestination}&t=&z=10&ie=UTF8&iwloc=&output=embed`;
                }
                const allPoints = [currentLocation.value, ...locations].filter(l => l.trim()).join(' and ');
                const searchContext = ` in ${tripSettings.value.destination}`;
                const encodedQuery = encodeURIComponent(allPoints + searchContext);
                return `https://maps.google.com/maps?q=${encodedQuery}&t=&z=10&ie=UTF8&iwloc=&output=embed`;
            });
            
            // Transaction Logic
            const newTransaction = ref({ time: new Date().toTimeString().substring(0, 5), type: 'expense', currency: 'JPY', amount: 0, notes: '' });
            const isTransactionValid = computed(() => newTransaction.value.amount > 0 && newTransaction.value.time && newTransaction.value.notes.trim());
            const filteredTransactions = computed(() => transactions.value.filter(tx => tx.date === selectedDate.value).sort((a, b) => (a.time > b.time ? 1 : -1)));
            
            const recalculateWallet = () => {
                let currentTWD = wallet.value.initialTWD || 0;
                let currentForeign = wallet.value.initialForeign || 0;
                transactions.value.forEach(tx => {
                    const amount = tx.amount || 0;
                    if (tx.currency === 'TWD') {
                        if (tx.type === 'expense') currentTWD -= amount;
                        if (tx.type === 'topup') currentTWD += amount;
                    } else if (tx.currency === tripSettings.value.currency) {
                        if (tx.type === 'expense') currentForeign -= amount;
                        if (tx.type === 'topup') currentForeign += amount;
                    }
                });
                wallet.value.currentTWD = Math.round(currentTWD);
                wallet.value.currentForeign = parseFloat(currentForeign.toFixed(2));
            };

            // Login Logic
            const loginAs = (member) => {
                currentUser.value = member;
                localStorage.setItem('myTripApp_currentUser', member); // ç°¡å–®è¨˜ä½æ˜¯èª°
                loadUserData(); // é‡æ–°è®€å–è©²ä½¿ç”¨è€…çš„è³‡æ–™
            };
            
            const logout = () => {
                currentUser.value = null;
                localStorage.removeItem('myTripApp_currentUser');
            }
            
            const getAvatar = (name) => {
                if (name.includes('çˆ¸')) return 'ğŸ‘¨ğŸ»';
                if (name.includes('åª½')) return 'ğŸ‘©ğŸ»';
                if (name.includes('å¼Ÿ')) return 'ğŸ‘¦ğŸ»';
                return 'ğŸ‘§ğŸ»'; // å§
            };

            // Firebase Update Helpers
            const updateFirestore = async (data, isInitialSetup = false) => {
                if (!tripDocRef) return;
                try { await setDoc(tripDocRef, data, { merge: !isInitialSetup }); } catch (e) { console.error("Firestore Error: ", e); }
            };

            const saveUserWallet = async (newWallet, newTransactions) => {
                if (!currentUser.value) return;
                // ä½¿ç”¨ currentUser çš„åå­—ä½œç‚º Key
                const updateData = {
                    userWallets: {
                        [currentUser.value]: {
                            wallet: newWallet,
                            transactions: newTransactions
                        }
                    }
                };
                await updateFirestore(updateData);
            };

            // Transaction Actions
            const addTransaction = async () => {
                if (!isTransactionValid.value || !currentUser.value) return;
                const tx = { id: generateId(), date: selectedDate.value, userId: currentUser.value, time: newTransaction.value.time, type: newTransaction.value.type, amount: parseFloat(newTransaction.value.amount), currency: newTransaction.value.currency, notes: newTransaction.value.notes, isEditing: false };
                
                const newTransactions = [...transactions.value, tx];
                transactions.value = newTransactions;
                recalculateWallet();
                await saveUserWallet(wallet.value, newTransactions);
                
                newTransaction.value.amount = 0;
                newTransaction.value.notes = '';
                newTransaction.value.time = new Date().toTimeString().substring(0, 5);
            };

            // Initialize Wallet Action (å€‹äººéŒ¢åŒ…è¨­å®š)
            const initializeWallet = async () => {
                if (budgetSetup.value.amountTWD <= 0) return;
                
                const initialTWD = budgetSetup.value.amountTWD;
                const initialForeign = budgetSetupCalculated.value;
                
                const newWallet = {
                    initialTWD: initialTWD,
                    initialForeign: initialForeign,
                    currentTWD: initialTWD,
                    currentForeign: initialForeign
                };
                
                // è¨­ç‚ºå…¥å¸³ç´€éŒ„ (å¯é¸ï¼Œé€™è£¡é¸æ“‡ä¸ç”¢ç”Ÿå…¥å¸³ç´€éŒ„ï¼Œç›´æ¥è¨­ç‚ºåˆå§‹é¤˜é¡)
                // æˆ–è€…ç”¢ç”Ÿä¸€ç­† "åˆå§‹å…¥å¸³"
                const initTx = {
                    id: generateId(),
                    date: tripDays.value[0]?.iso || new Date().toISOString().split('T')[0],
                    userId: currentUser.value,
                    time: '00:00',
                    type: 'topup',
                    currency: 'TWD', // é‚è¼¯ä¸Šåˆå§‹æ˜¯å°å¹£
                    amount: initialTWD, // é€™è£¡é¡¯ç¤ºå°å¹£é‡‘é¡ï¼Œä½†ç³»çµ±æœƒæ ¹æ“š initialForeign è¨ˆç®—å¤–å¹£é¤˜é¡
                    notes: 'åˆå§‹æ—…éŠé ç®—',
                    isEditing: false
                };
                // ç‚ºäº†è®“é‚è¼¯ç°¡å–®ï¼Œæˆ‘å€‘ç›´æ¥æ›´æ–° wallet çš„ initial å€¼ï¼Œä¸å¼·åˆ¶åŠ ä¸€ç­† transactionï¼Œ
                // é€™æ¨£é¡¯ç¤ºé¤˜é¡æœ€æº–ç¢ºã€‚
                
                wallet.value = newWallet;
                await saveUserWallet(newWallet, transactions.value);
            };

            const editTransaction = (tx) => {
                editingTransaction.value = JSON.parse(JSON.stringify(tx));
                editingTxId.value = tx.id;
                nextTick(() => { lucide.createIcons(); });
            };

            const cancelEdit = () => {
                editingTxId.value = null;
                editingTransaction.value = null;
            };

            const saveEdit = async () => {
                const txId = editingTxId.value;
                const editedTx = editingTransaction.value;
                if (!editedTx.amount || editedTx.amount <= 0 || !editedTx.notes.trim()) return;
                const newTransactions = transactions.value.map(tx => (tx.id === txId ? { ...tx, ...editedTx, amount: parseFloat(editedTx.amount) } : tx));
                transactions.value = newTransactions;
                recalculateWallet();
                cancelEdit();
                await saveUserWallet(wallet.value, newTransactions);
            };

            const deleteTransaction = async (txId) => {
                const newTransactions = transactions.value.filter(tx => tx.id !== txId);
                transactions.value = newTransactions;
                recalculateWallet();
                if(editingTxId.value === txId) cancelEdit();
                await saveUserWallet(wallet.value, newTransactions);
            };

            const updateExchangeRate = debounce(async () => {
                const rate = parseFloat(tripSettings.value.rateTWD);
                if (rate > 0 && !isNaN(rate)) await updateFirestore({ tripSettings: tripSettings.value });
            }, 500); 

            const mockFetchWeather = (location) => new Promise(resolve => setTimeout(() => resolve(`${(tripSettings.value.currency === 'JPY' ? 10 : 15) + Math.floor(Math.random() * 8) - 4}`), 300));
            const toggleMapPin = async (item) => { item.checked = !item.checked; await updateFirestore({ itinerary: itinerary.value }); };
            const addNewItem = async (date) => {
                if (date === '') return; 
                const currentItinerary = JSON.parse(JSON.stringify(itinerary.value));
                if (!currentItinerary[date]) { currentItinerary[date] = []; }
                const newItem = { id: generateId(), time: new Date().toTimeString().substring(0, 5), location: '', notes: '', temp: await mockFetchWeather('æ–°è¡Œç¨‹'), isEditing: true, checked: true };
                currentItinerary[date].push(newItem);
                await updateFirestore({ itinerary: currentItinerary });
            };
            const editItem = (date, index) => {
                if(itinerary.value[date] && itinerary.value[date][index]) {
                    for(const day in itinerary.value) itinerary.value[day].forEach(item => item.isEditing = false);
                    itinerary.value[date][index].isEditing = true;
                    nextTick(() => { lucide.createIcons(); });
                }
            };
            const saveItem = async (date, index) => {
                const item = itinerary.value[date][index];
                if (!item.location.trim()) return;
                item.temp = await mockFetchWeather(item.location);
                item.isEditing = false;
                await updateFirestore({ itinerary: itinerary.value });
            };
            const deleteItem = async (date, index) => {
                const currentItinerary = JSON.parse(JSON.stringify(itinerary.value));
                currentItinerary[date].splice(index, 1);
                itinerary.value = currentItinerary;
                await updateFirestore({ itinerary: currentItinerary });
            };

            const getSingleMapLink = (location) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(tripSettings.value.destination + ' ' + location)}`;
            
            // Initial Setup (By Admin)
            const saveInitialSetup = async () => {
                if (!isWizardValid.value || !currentUser.value) return;
                const settings = detectedSettings.value;
                const rate = parseFloat(wizard.value.rateInput);
                
                const newSettings = { appName: wizard.value.appNameInput, destination: settings.name, startDate: wizard.value.startDateInput, endDate: wizard.value.endDateInput, currency: settings.currency, rateTWD: rate, language: settings.language, exampleLocation: settings.exampleLocation };
                
                const initialItinerary = {};
                let currentDate = new Date(newSettings.startDate + 'T00:00:00Z');
                const endDate = new Date(newSettings.endDate + 'T00:00:00Z');
                while (currentDate.getTime() <= endDate.getTime()) {
                    initialItinerary[currentDate.toISOString().split('T')[0]] = [];
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // ä¸å†è¨­å®šåˆå§‹éŒ¢åŒ…ï¼Œåªè¨­å®šè¡Œç¨‹çµæ§‹
                const initialData = {
                    tripSettings: newSettings,
                    itinerary: initialItinerary,
                    userWallets: {} // æ¸…ç©ºå¤§å®¶éŒ¢åŒ…ï¼Œç­‰å¾…å„è‡ªè¨­å®š
                };
                await updateFirestore(initialData, true);
            };

            const resetSetup = async () => {
                if (!

